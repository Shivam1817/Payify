# Use a specific and lightweight base image
FROM node:20-alpine AS base

# Set the working directory
WORKDIR /app

# Install dependencies needed for the build
RUN npm install -g turbo

# Copy the necessary package manager and config files
COPY . .

# Use Turborepo to prune the monorepo to only include the user-app
RUN turbo prune --scope=user-app --docker

# --- Build Stage ---
FROM node:20-alpine AS builder
WORKDIR /app

# Copy the pruned files from the base stage
COPY --from=base /app/out/json/ .
COPY --from=base /app/out/full/ .

# Install dependencies
RUN npm install

# Generate the Prisma client
RUN npm run db:generate

# Build only the user-app
RUN turbo run build --filter=user-app...

# --- Runner Stage ---
FROM node:20-alpine AS runner
WORKDIR /app

# Copy the pruned files from the base stage
COPY --from=base /app/out/json/ .
COPY --from=base /app/out/full/ .

# Install production dependencies
RUN npm install --omit=dev

# Copy the built app from the builder stage
COPY --from=builder /app/apps/user-app/.next ./apps/user-app/.next
COPY --from=builder /app/apps/user-app/node_modules ./apps/user-app/node_modules
COPY --from=builder /app/apps/user-app/package.json ./apps/user-app/package.json

# Expose the port that the app will run on
EXPOSE 3000

# Start the user-app
CMD ["npm", "run", "start-user-app"]